# 平方根を求めるアルゴリズムの実験

平方根を求めるアルゴリズムもいろいろあるので実装、実験してみた。参考文献は[平方根の任意多倍長計算法の例](http://www.kurims.kyoto-u.ac.jp/~kyodo/kokyuroku/contents/pdf/1927-03.pdf)

# 問題設定

円周率を求める公式の代表例である Chudnovsky の公式では BS を行った結果の R/S (R, S は長い桁の整数)に対して sqrt(10005) をかけ、S で割る作業を行って計算する。
上記参考文献によると整数演算を用いた平方根の計算も多種ありそうなので有用そうな方法があれば使っていきたい。以下、sqrt(10005) を求める時間を比較するとともに、有理数近似を求めるアルゴリズムに関しては特に除算を1つにまとめられることから平方根＋除算の時間を計測して比較していく。

# 手法の紹介
除算については GMP の内部実装を使うということにして、平方根を求める部分のアルゴリズムを紹介する。

## GMP
GMP の `mpf_sqrt_ui()` で実装されている方法。基本的に整数→整数の演算が前提になっているが、平方根はビット位置の調整をするだけで整数、浮動小数点数の違いが実質的に無くなるので気にしない。
アルゴリズムをザックリいうと、4 桁の整数の平方根をとって 2 桁にする方法を適用する。

1. 入力全体を n ビットずつ 4 分割する。ただし最上位は n ビットか n - 1 ビットあるようにビットシフト調整する。
1. 上 2 分割分の平方根を求める。これは同じアルゴリズムを再帰的に適用することで求められる。x とする。
1. 2x で余りを割り(商を y とする)、更に y^2 を引く。
  1. 余りが負になったら商を 1 減らす。y^2 の調整もする。

という感じだ。[GMP のドキュメント](https://gmplib.org/manual/Square-Root-Algorithm.html#Square-Root-Algorithm)によるとこれも Karatsuba 法というらしい。

## 実数逆数ニュートン法
[円周率.jp](http://xn--w6q13e505b.jp/method/newton.html) で紹介している方法。特に工夫なく。

## 整数ニュートン法
平方根を有理数近似して、ニュートン法を適用させる。誤差評価がいまいちわからない。

## 固有値法
[参考資料](http://www.kurims.kyoto-u.ac.jp/~kyodo/kokyuroku/contents/pdf/1927-03.pdf)で漸化式方式と呼ばれている方法。2x2 行列の固有ベクトルをうまく使うっぽい。

## 連分数法
同じく[参考資料](http://www.kurims.kyoto-u.ac.jp/~kyodo/kokyuroku/contents/pdf/1927-03.pdf)から。

# 実験結果

## 平方根のみ

2^20 - 2^25 ビットを対象に計算してみた時間はこちら。単位は sec。計算ターゲットは Chudnovsky の公式に出てくる√10005。連分数の数字列の算出など事前準備可能系はなるべく計測時間に含めていない。

|ビット数|mpf|逆数ニュートン|有理数ニュートン|固有値|連分数|
|----|----:|----:|----:|----:|----:|
|2^20|0.013|0.023|0.041|0.060|0.028|
|2^21|0.038|0.070|0.091|0.116|0.061|
|2^22|0.092|0.140|0.320|0.263|0.137|
|2^23|0.180|0.274|0.449|0.759|0.380|
|2^24|0.449|0.760|1.138|1.399|0.699|
|2^25|0.853|1.633|2.208|3.199|1.557|

ちなみに 100 + √10005 = [200, 40] と連分数の繰り返しが少ない。

## 除算込み

|ビット数|mpf|逆数ニュートン|有理数ニュートン|固有値|連分数|
|----|----:|----:|----:|----:|----:|
|2^20|0.029|0.039|0.048|0.057|0.032|
|2^21|0.073|0.088|0.108|0.130|0.077|
|2^22|0.159|0.194|0.257|0.297|0.189|
|2^23|0.346|0.462|0.567|0.693|0.392|
|2^24|0.768|1.051|1.268|1.594|0.909|
|2^25|1.807|2.415|2.765|3.532|2.114|

それなりに連分数法がいい勝負をしているけど結局組み込み演算が最速。

# 考察

特徴としてはニュートン法はやはり 2 次収束なので精度が倍々でしか増えないので微調整しにくい。他の方法は微調整しやすいっぽい。連分数は実数ニュートン法に匹敵する速度でより柔軟な精度調整ができるっぽいので使い勝手がいいかもしれない。
